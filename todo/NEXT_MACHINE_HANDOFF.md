# Next Machine Handoff

## Snapshot
- Date: 2026-02-13
- Branch: `main`
- HEAD: `97a1b3af8b67696bb78e76e5452cf38f665de2f0`
- Last commit: `97a1b3a 2026-02-13 10:06:43 -0600 Extract mixed-method final parity helper`
- Working tree at handoff creation: dirty (`unit phase-list assertion vector constant reuse`)
- Validation status:
  - `./.venv313/bin/python --version` => `Python 3.13.12`
  - `./.venv313/bin/ruff format .` passes
  - `./.venv313/bin/ruff check .` passes
  - `PYTHONPATH=src ./.venv313/bin/mypy` passes
  - `PYTHONPATH=src ./.venv313/bin/pytest` passes (`235 passed`)

## Recent Delivered Work
- Extended repeated phase-list assertion vector constant reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_INITIALIZE_START_FAILURE_PHASES` and `UNIT_TEST_INVOKE_START_SUCCESS_PHASES` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side phase-list expectations (`[UNIT_TEST_INITIALIZE_START_PHASE, UNIT_TEST_INITIALIZE_FAILURE_PHASE]` and `[UNIT_TEST_INVOKE_START_PHASE, UNIT_TEST_INVOKE_SUCCESS_PHASE]`) to shared constants in timeout-phase and invocation-event filter assertions while keeping registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended capability snapshot `server_info` assertion dictionary constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_GITHUB_SERVER_INFO` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side comparisons against `{"name": "github", "version": "2.0.0"}` for `capability_snapshot.server_info` to the shared constant while keeping registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended remaining order-test failure-action timeout/error assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_FAILURE_ACTION_TIMEOUT` in `tests/unit/test_mcp_client.py`.
  - migrated remaining order-test and adjacent scripted isolation `consume_failure_action(... ) == "timeout"` assertions to `UNIT_TEST_FAILURE_ACTION_TIMEOUT` and migrated the remaining order-test `== "error"` assertion to existing `UNIT_TEST_FAILURE_ACTION_ERROR`, while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended remaining order-test failure-action `"ok"` assertion constant reuse in unit MCP client coverage:
  - reused existing local unit-test constant `UNIT_TEST_FAILURE_ACTION_OK` in `tests/unit/test_mcp_client.py`.
  - migrated the remaining `consume_failure_action(... ) == "ok"` checks in `test_cluster_nat_failure_script_order_and_validation` to the shared constant while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended scripted failure-action `"ok"` assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_FAILURE_ACTION_OK` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `consume_failure_action(... ) == "ok"` checks in scripted failure isolation assertions to the shared constant while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended scripted failure-action `"error"` assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_FAILURE_ACTION_ERROR` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `consume_failure_action(... ) == "error"` checks in scripted failure isolation assertions to the shared constant while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended failure-script `["error"]` assertion-vector constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_FAILURE_SCRIPT_ERROR_VECTOR` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `["error"]` primary `resources/read` failure-script queue vectors in scripted failure isolation assertions to the shared constant while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended failure-script `["ok"]` assertion-vector constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_FAILURE_SCRIPT_OK_VECTOR` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `["ok"]` failure-script queue vectors in scripted failure isolation assertions to the shared constant while keeping `set_failure_script(...)` setup inputs, registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended freshness-state assertion constant reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_FRESHNESS_UNKNOWN`, `UNIT_TEST_FRESHNESS_ACTIVE_RECENT`, and `UNIT_TEST_FRESHNESS_STALE` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side freshness literals (`"unknown"`, `"active_recent"`, and `"stale"`) in adapter session freshness diagnostics assertions to shared constants while keeping registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended resource URI assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_PROJECTS_URI` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side inline `"att://projects"` checks in resource read result assertions and expected adapter `session.calls` vectors to the shared constant while keeping registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended protocol-version assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_PROTOCOL_VERSION` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side inline `"2025-11-25"` protocol-version checks (initialize response assertion and capability snapshot protocol assertions) to the shared constant while keeping registration/setup literals, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended event-filter server-argument constant reuse in unit MCP client coverage:
  - reused `UNIT_TEST_PRIMARY_SERVER` and `UNIT_TEST_BACKUP_SERVER` in remaining assertion-adjacent invocation/connection event filter calls within `test_event_list_filters_and_limits` in `tests/unit/test_mcp_client.py`.
  - replaced inline `server="primary"` and `server="backup"` filter arguments with shared constants while keeping registration/setup literals, preferred-order inputs, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended isolated `codex` server-name assertion constant reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_CODEX_SERVER` in `tests/unit/test_mcp_client.py`.
  - migrated remaining assertion-side inline `"codex"` server literals in stale-reinitialize, auto-initialize, connect-server probe-call vector, and correlation-event checks to the shared constant while keeping registration/setup literals, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended adapter filter assertion server-name constant reuse for `c` vectors in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_SERVER_C` in `tests/unit/test_mcp_client.py`.
  - migrated remaining assertion-side `c` server literals in adapter filter/listing checks (`active_only`, single-server filter, and limit result vectors) to the shared constant while keeping registration/setup literals, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended remaining non-adapter `a`/`b` server-name assertion constant reuse in unit MCP client coverage:
  - reused `UNIT_TEST_SERVER_A` and `UNIT_TEST_SERVER_B` in remaining non-adapter assertion vectors (`choose_server` preference assertions and `initialize_all` name-vector assertion) in `tests/unit/test_mcp_client.py`.
  - kept registration/setup literals, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended adapter-session server-name assertion literal reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_NAT_SERVER`, `UNIT_TEST_SERVER_A`, and `UNIT_TEST_SERVER_B` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side adapter diagnostics/filter server literals (`"nat"`, `"a"`, `"b"`) to shared constants while keeping adapter/session setup behavior, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended adapter/session identity assertion constant reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_SESSION_ID_FIRST` and `UNIT_TEST_SESSION_ID_SECOND` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side session-id literals (`"session-1"` / `"session-2"`) in adapter refresh/reconnect identity assertions to shared constants while keeping adapter/session setup behavior and transport method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended unit MCP client error-attempt assertion constant reuse for invoke-stage checks:
  - added local unit-test constant `UNIT_TEST_INVOKE_STAGE` in `tests/unit/test_mcp_client.py`.
  - migrated remaining repeated assertion-side error-attempt stage literal `"invoke"` checks to the shared constant while keeping error setup payload literals, scripted setup inputs, and transport method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended stable server-name assertion literal reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_PRIMARY_SERVER`, `UNIT_TEST_BACKUP_SERVER`, `UNIT_TEST_SECONDARY_SERVER`, `UNIT_TEST_RECOVERED_SERVER`, and `UNIT_TEST_DEGRADED_SERVER` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side server literals across failover/call-order/failure-script assertion vectors to shared constants while keeping server-registration/setup literals, transport request payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended adapter/session call-order assertion tuple constant reuse in unit MCP client coverage:
  - reused `UNIT_TEST_INITIALIZE_METHOD` in the remaining adapter/session expected-call assertions that still used inline `"initialize"` tuple entries in `tests/unit/test_mcp_client.py`.
  - completed initialization-notify/method assertion tuple constantization across adapter/session call-order expectations while keeping transport request payload literals and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended stable initialization-notify assertion literal reuse in unit MCP client coverage:
  - added local unit-test constant `UNIT_TEST_NOTIFICATIONS_INITIALIZED_METHOD` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `"notifications/initialized"` literals in invocation/call-order/transport-call expectations to the shared constant while keeping transport request payload literals and transport method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended stable `resources/read` and invocation phase assertion-literal constant reuse in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_RESOURCES_READ_METHOD`, `UNIT_TEST_INITIALIZE_START_PHASE`, `UNIT_TEST_INITIALIZE_FAILURE_PHASE`, `UNIT_TEST_INITIALIZE_SUCCESS_PHASE`, and `UNIT_TEST_INVOKE_SUCCESS_PHASE` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side `resources/read` method literals and repeated invocation phase literals to shared constants across fallback, failure-script isolation, call-order, and event-filter assertions while keeping scripted setup inputs, transport payload literals, and method-branch conditionals explicit and unchanged.
  - preserved timeout-category regression semantics plus invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
- Extended cluster failure-script and call-order assertion method-literal reuse in unit MCP client coverage:
  - reused `UNIT_TEST_INITIALIZE_METHOD` and `UNIT_TEST_TOOLS_CALL_METHOD` across repeated cluster failure-script assertions (`consume_failure_action` + `failure_scripts` key checks) and cluster call-order expectation vectors/filter sets in `tests/unit/test_mcp_client.py`.
  - kept scripted setup inputs (`set_failure_script(...)`) and method-branch conditionals explicit and unchanged.
  - preserved retry-window/call-order parity semantics and invocation/connection filter behavior unchanged.
- Extended unit MCP client assertion literal reuse to stable method/phase constants:
  - added local unit-test constants `UNIT_TEST_INITIALIZE_METHOD`, `UNIT_TEST_TOOLS_CALL_METHOD`, `UNIT_TEST_INVOKE_START_PHASE`, and `UNIT_TEST_INVOKE_FAILURE_PHASE` in `tests/unit/test_mcp_client.py`.
  - migrated repeated assertion-side method/phase literals in invocation result/call-order/phase-stream checks to the shared constants while keeping setup transport payload literals and timeout/category param matrices explicit and unchanged.
  - preserved invocation-event/connection-event filter semantics and call-order/subsequence behavior unchanged.
- Reduced non-timeout error-category assertion literal duplication in unit MCP client coverage:
  - added local unit-test constants `UNIT_TEST_TRANSPORT_ERROR_CATEGORY`, `UNIT_TEST_RPC_ERROR_CATEGORY`, and `UNIT_TEST_HTTP_STATUS_ERROR_CATEGORY` in `tests/unit/test_mcp_client.py`.
  - migrated repeated non-timeout category assertion literals to the shared constants while keeping timeout/category mapping param matrices and transport exception setup literals explicit and unchanged.
  - preserved invocation failure-trace semantics and transport error-category propagation assertions unchanged.
- Extended timeout-category constant reuse into adjacent unit MCP client assertions:
  - added local unit-test constant `UNIT_TEST_TIMEOUT_ERROR_CATEGORY` in `tests/unit/test_mcp_client.py`.
  - replaced remaining inline `"network_timeout"` literals in timeout-category assertions with the shared unit-test constant while keeping the timeout exception-to-category param matrix explicit and unchanged.
  - preserved transport adapter category-mapping semantics and failure-script exhaustion fallback behavior unchanged.
- Completed timeout-category compatibility alias retirement after neutral adoption:
  - migrated the remaining failover timeout-category assertions to canonical `FAILOVER_TIMEOUT_ERROR_CATEGORY`.
  - replaced the remaining inline `"network_timeout"` last-error-category assertion with the canonical timeout constant and removed `SCRIPTED_FAILOVER_TIMEOUT_ERROR_CATEGORY`.
  - updated focused constant regression coverage to canonical-only timeout-category semantics and preserved invocation/connection filter behavior plus call-order/subsequence parity unchanged.
- Consolidated timeout-category constant naming across scripted and non-scripted failover diagnostics assertions:
  - introduced neutral `FAILOVER_TIMEOUT_ERROR_CATEGORY` and rewired timeout-category assertions to use the neutral constant instead of scripted-only naming.
  - updated focused constant regression coverage to assert neutral timeout-category value plus compatibility-alias equivalence.
  - preserved invocation/connection filter behavior and call-order/subsequence parity semantics unchanged.
- Retired degraded-status compatibility alias debt after canonical ownership migration:
  - removed `SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES` compatibility alias and retained only canonical `FAILOVER_DEGRADED_EXPECTED_STATUSES` for degraded-status expectations.
  - updated focused constant regression coverage to assert canonical degraded-status vector semantics without alias coupling.
  - preserved invocation/connection filter behavior and call-order/subsequence parity semantics unchanged.
- Canonicalized degraded-status constant ownership after alias adoption:
  - made `FAILOVER_DEGRADED_EXPECTED_STATUSES` the literal-defined canonical degraded-status tuple.
  - kept `SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES` as a compatibility alias to the neutral constant and updated focused constant regression coverage to assert canonical-vector and alias-equivalence semantics.
  - preserved invocation/connection filter behavior and call-order/subsequence parity semantics unchanged.
- Consolidated degraded-status constant naming across scripted and non-scripted failover diagnostics assertions:
  - migrated remaining scripted failover `expected_statuses` call sites from `list(SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES)` to `list(FAILOVER_DEGRADED_EXPECTED_STATUSES)` for consistent assertion wiring.
  - kept scripted constant regression coverage and added explicit alias parity assertion (`FAILOVER_DEGRADED_EXPECTED_STATUSES == SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES`) to lock semantic equivalence.
  - preserved invocation/connection filter semantics and call-order/subsequence parity behavior unchanged.
- Reduced final duplicated degraded-status vectors in non-scripted diagnostics assertions:
  - introduced neutral constant alias `FAILOVER_DEGRADED_EXPECTED_STATUSES` in `tests/integration/test_api_mcp.py` to decouple generic degraded-status assertions from scripted-only naming.
  - replaced non-scripted `expected_statuses=[ServerStatus.DEGRADED.value]` vectors in event-endpoint filter coverage and resource failover/recovery diagnostics coverage with `list(FAILOVER_DEGRADED_EXPECTED_STATUSES)`.
  - eliminated remaining inline degraded-status vectors in `tests/integration/test_api_mcp.py` while preserving invocation/connection filter semantics and call-order/subsequence parity behavior.
- Reduced duplicated degraded-status vectors in remaining scripted failover diagnostics assertions (outside stage-paired and transport-error tests):
  - replaced scripted failover `expected_statuses=[ServerStatus.DEGRADED.value]` vectors in initialize/invoke isolation, initialize-script exhaustion fallback, and scripted initialize-precedence tool/resource tests with `list(SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES)`.
  - intentionally left non-scripted degraded-status vectors unchanged in this slice to preserve handoff scope boundaries.
  - preserved invocation/connection filter semantics and call-order/subsequence parity behavior unchanged.
- Reduced duplicated degraded-status vectors in scripted transport-error failover diagnostics assertions:
  - replaced scripted transport-error failover `expected_statuses=[ServerStatus.DEGRADED.value]` vectors in both tool/resource error-action tests with `list(SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES)`.
  - kept diagnostics filter and call-order assertions explicit at each test call site while reusing the shared degraded-status constant.
  - preserved invocation/connection filter semantics and call-order/subsequence parity behavior unchanged.
- Reduced duplicated degraded-status vectors in stage-paired timeout convergence diagnostics assertions:
  - replaced stage-paired tool/resource timeout convergence `expected_statuses=[ServerStatus.DEGRADED.value]` vectors with `list(SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES)`.
  - kept diagnostics filter and call-order assertions explicit at each test call site while reusing the shared degraded-status constant.
  - preserved invocation/connection filter semantics and call-order/subsequence parity behavior unchanged.
- Reduced duplicated stage-paired timeout-stage failover expectation wiring:
  - added shared helper `_stage_paired_failover_expectations_for_timeout_stage(...)` that maps `timeout_stage` to failover phase/server vectors and failover error-index constants.
  - migrated both stage-paired retry-window convergence tests (tool/resource) to consume the helper for expectation mapping while keeping method-specific timeout-toggle wiring explicit at each test call site.
  - added focused regression coverage locking helper mapping semantics for both `initialize` and `invoke` timeout stages and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated stage-paired failover invoke-timeout phase/server vectors:
  - extracted shared constants `STAGE_PAIRED_INVOKE_TIMEOUT_FAILOVER_EXPECTED_PHASES` and `STAGE_PAIRED_INVOKE_TIMEOUT_FAILOVER_EXPECTED_SERVERS` for repeated invoke-timeout failover vector literals in tool/resource retry-window convergence assertions.
  - migrated both stage-paired convergence invoke-timeout branches to consume the constants while keeping diagnostics filter, timeout-category, and call-order assertions explicit at each test call site.
  - added focused regression coverage locking invoke-timeout failover vector values and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated stage-paired failover initialize-timeout phase/server vectors:
  - extracted shared constants `STAGE_PAIRED_INITIALIZE_TIMEOUT_FAILOVER_EXPECTED_PHASES` and `STAGE_PAIRED_INITIALIZE_TIMEOUT_FAILOVER_EXPECTED_SERVERS` for repeated initialize-timeout failover vector literals in tool/resource retry-window convergence assertions.
  - migrated both stage-paired convergence initialize-timeout branches to consume the constants while keeping diagnostics filter, timeout-category, and call-order assertions explicit at each test call site.
  - added focused regression coverage locking initialize-timeout failover vector values and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated stage-paired failover initialize-stage error-index literals:
  - extracted shared constant `STAGE_PAIRED_FAILOVER_INITIALIZE_ERROR_INDEX` for repeated `failover_error_index = 1` assignments in tool/resource retry-window convergence failover assertions.
  - migrated both stage-paired convergence initialize-timeout branches to consume the constant while keeping diagnostics filter, timeout-category, and call-order assertions explicit at each test call site.
  - added focused regression coverage locking the initialize-stage constant value and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated stage-paired failover invoke-stage error-index literals:
  - extracted shared constant `STAGE_PAIRED_FAILOVER_INVOKE_ERROR_INDEX` for repeated `failover_error_index = 3` assignments in tool/resource retry-window convergence failover assertions.
  - migrated both stage-paired convergence test branches to consume the constant while keeping diagnostics filter, timeout-category, and call-order assertions explicit at each test call site.
  - added focused regression coverage locking the constant value and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Expanded scripted failover timeout-category constant adoption in adjacent invocation-event assertions:
  - migrated remaining adjacent failover invocation-event `error_category` assertions still using inline `"network_timeout"` literals to `SCRIPTED_FAILOVER_TIMEOUT_ERROR_CATEGORY`.
  - adoption now covers mixed-state failover and stage-paired tool/resource retry-window convergence failover assertions while keeping diagnostics-filter and call-order assertions explicit.
  - preserved invocation/connection filter semantics, call-order literal expectations, and phase-start/transport subsequence parity behavior unchanged.
- Reduced duplicated scripted mixed-method failover timeout-category assertions:
  - extracted shared constant `SCRIPTED_FAILOVER_TIMEOUT_ERROR_CATEGORY` for repeated `"network_timeout"` assertions in scripted mixed-method failover invocation-event checks.
  - migrated scripted mixed-method tool/resource failover invocation-event assertions to consume the shared timeout-category constant while keeping diagnostics-filter and call-order assertions explicit at test call sites.
  - added focused regression coverage locking the timeout-category constant value and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated scripted mixed-method failover degraded-status vectors:
  - extracted shared tuple constant `SCRIPTED_FAILOVER_DEGRADED_EXPECTED_STATUSES` for repeated single-item degraded status expectations in scripted mixed-method connection-event filters.
  - migrated scripted mixed-method tool/resource failover connection-event filter assertions to consume the shared constant while keeping diagnostics-filter assertions explicit at each test call site.
  - added focused regression coverage locking the shared degraded-status vector and preserved invocation/connection filter semantics plus call-order/subsequence parity behavior unchanged.
- Reduced duplicated scripted mixed-method failover filter phase vectors:
  - extracted shared tuple constant `SCRIPTED_FAILOVER_FILTER_EXPECTED_PHASES` for repeated 4-step failure filter phase assertions.
  - migrated scripted mixed-method tool/resource failover filter assertions to consume the shared constant while keeping diagnostics-filter calls explicit at test call sites.
  - added focused regression coverage locking the shared filter-phase vector and preserved invocation/connection filter semantics, call-order literals, and subsequence parity behavior unchanged.
- Reduced duplicated scripted mixed-method failover phase/server expectation vectors:
  - extracted shared tuple constants for the repeated 8-step failover invocation phase vector and method-specific server-order vectors.
  - migrated scripted mixed-method failover assertions to consume the shared constants while keeping all diagnostics filter assertions explicit at test call sites.
  - added focused regression coverage locking constant vector values and preserved call-order literal + phase-start/transport subsequence semantics unchanged.
- Reduced duplicated mixed-method scripted request-id tuple wiring in call-order parity tests:
  - added shared helper `_mixed_method_scripted_request_ids(...)` for scripted mixed-method parity request-id tuple assembly.
  - added focused helper regression `test_mixed_method_scripted_request_ids_helper_preserves_order` and migrated scripted call-order parity assertion wiring to use the helper.
  - preserved existing diagnostics filter assertions, observed call-order literal assertions, and phase-start/transport subsequence parity semantics unchanged.
- Expanded mixed-method parity-helper adoption scope in call-order tests:
  - migrated remaining scripted mixed-method call-order parity assertion call site to `_assert_mixed_method_call_order_parity(...)`.
  - removed the last mixed-method direct invocation of `_assert_call_order_subsequence_for_requests(...)` at test call sites.
  - preserved request-id sequencing semantics, observed call-order collection behavior, and diagnostics-filter expectations unchanged.
- Reduced duplicated mixed-method final parity assertion wiring in call-order tests:
  - added shared helper for mixed-method phase-start/transport subsequence parity assertions based on request-id vectors and observed call-order tuples.
  - migrated repeated-same-server and force-reinitialize mixed-method call-order tests to helper-driven final parity assertions.
  - preserved explicit request-id sequencing, expected observed call-order literals, and diagnostics-filter semantics unchanged.
- Reduced duplicated mixed-method primary setup scaffolding in call-order tests:
  - added shared helper for primary mixed-method harness setup (`ClusterNatSessionFactory` + `MCPClientManager` + `TestClient` + primary server registration).
  - helper supports optional `now_provider` injection and force-reinitialize coverage now consumes it to preserve deterministic stale-expiry trigger behavior.
  - migrated repeated-same-server and force-reinitialize tests to helper-driven setup while preserving explicit trigger mutations and call-order expectations.
- Reduced duplicated mixed-method request-execution scaffolding in call-order tests:
  - added shared helper that executes mixed-method request sequences (request post + request-id collection + primary success diagnostics assertions).
  - added optional per-index pre-request mutation hook and migrated force-reinitialize trigger mutations to the hook while preserving explicit trigger conditions.
  - migrated repeated-same-server and force-reinitialize tests to helper-driven request execution while preserving explicit request-spec/status vectors and call-order expectations.
- Reduced duplicated mixed-method call-order literal assertion wiring in call-order tests:
  - added shared helper to collect mixed-method observed transport call order and assert expected literal vectors.
  - migrated repeated-same-server and force-reinitialize call-order tests to helper-driven literal assertions while keeping explicit expected vectors at test call sites.
  - preserved diagnostics-filter assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated mixed-method observed call-order literal vectors in call-order tests:
  - extracted shared expected observed call-order constants for repeated-same-server and force-reinitialize mixed-method call-order tests.
  - rewired both tests to assert against tuple-backed shared constants while preserving literal call-order auditability.
  - preserved existing diagnostics-filter assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated mixed-method request-spec scaffolding in call-order tests:
  - extracted shared mixed-method primary request-spec constants used by repeated-same-server and force-reinitialize call-order tests.
  - extracted shared force-reinitialize expected-status vectors and rewired loop iteration to zip shared request specs with behavior-specific status expectations.
  - preserved reinitialize trigger mutations, diagnostics assertions, and call-order literal/subsequence checks unchanged.
- Reduced duplicated primary success diagnostics assertion wiring in mixed-method call-order tests:
  - added shared helper for primary successful-request diagnostics (`initialize_success` + `invoke_success` phases) with per-request expected status handling.
  - migrated loop-based diagnostics assertions in repeated-same-server and force-reinitialize call-order tests to the helper.
  - preserved existing request sequencing, call-order literal assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window gating bootstrap wiring:
  - added shared helper for method-specific retry-window gating bootstrap (harness setup + method-specific invoke failure script + invoke wiring + gating sequence run).
  - migrated tool/resource retry-window gating tests to this helper while preserving explicit per-method diagnostics/call-order vectors.
  - preserved progression semantics, diagnostics filter assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window unreachable-transition bootstrap wiring:
  - added a shared helper for method-specific unreachable-transition bootstrap (harness setup + primary initialize timeout script + invoke wiring + sequence run).
  - migrated tool/resource unreachable-transition retry-window tests to this helper while preserving explicit per-method diagnostics and call-order expectation constants.
  - preserved progression semantics, diagnostics filter assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window invoke-builder scaffolding:
  - added dedicated tool/resource invoke-builder helper wrappers around shared preferred-server invoke construction.
  - migrated tool/resource retry-window gating and unreachable-transition tests to wrapper helpers, removing repeated inline invoke-path/payload scaffolding.
  - preserved request progression semantics, diagnostics assertions, and call-order parity checks unchanged.
- Reduced duplicated call-order subsequence assertion wiring with shared helper:
  - added shared helper that derives expected call-order from request ids and performs subsequence assertion against observed transport order.
  - migrated retry-window/unreachable-transition and adjacent call-order tests to the helper while preserving explicit observed-call-order literals.
  - preserved diagnostics filter semantics and phase-start/transport subsequence behavior unchanged.
- Normalized primary phase/status expectation vector typing for consistency:
  - converted primary unreachable-transition and retry-window gating phase/status expectation constants to immutable tuple-based inner vectors.
  - updated shared primary diagnostics helper typing to accept `Sequence[Sequence[str]]` and normalized assertion-boundary inputs to concrete lists.
  - preserved diagnostics filter semantics, call-order literal assertions, and phase-start/transport subsequence checks unchanged.
- Normalized call-order expectation vector typing/signatures for consistency:
  - converted method-specific call-order expectation constants to immutable tuple-based vectors.
  - updated call-order helper signatures to accept `Sequence[tuple[str, str]]` and normalized assertions to compare list-observed order with sequence-backed expectation constants.
  - preserved call-order literal semantics, diagnostics filter assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated mixed-method observed-call-order collection scaffolding with shared helper wiring:
  - added shared helper utility to collect observed transport call-order tuples for mixed-method scenarios (`initialize` + `tools/call` + `resources/read`).
  - migrated remaining mixed-method call-order tests to consume this helper while preserving explicit expected observed-order literals.
  - preserved diagnostics filter assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated expected-call-order derivation scaffolding with shared helper wiring:
  - added shared helper utility that derives expected call-order tuples directly from request-id scoped invocation events.
  - migrated retry-window/unreachable-transition and adjacent call-order tests to consume the helper instead of repeating event-collection + phase-start derivation scaffolding.
  - preserved request-id ordering semantics, call-order literal assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated request-id tuple scaffolding in retry-window and unreachable-transition tests:
  - added shared helper utilities to derive ordered request-id tuples from `RetryWindowGatingSequence` and `UnreachableTransitionSequence`.
  - migrated tool/resource retry-window gating and unreachable-transition tests to consume these helpers for diagnostics/event filtering inputs.
  - preserved diagnostics filter assertions, call-order literal assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated call-order collection scaffolding with shared helper wiring:
  - added shared transport call-order collection helper for method-scoped `initialize` + invoke call tuples with optional start offsets.
  - migrated unreachable-transition and retry-window gating call-order helpers to consume this shared collector while preserving existing per-slice literal assertions (`second_slice`/`third_slice`/`fifth_slice`).
  - preserved diagnostics filter assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated unreachable-transition call-order expectation vectors with shared constants:
  - extracted shared module-level constants for method-specific unreachable-transition call-order expectations (`expected_fifth_slice` and full `expected_observed_call_order` tuples).
  - migrated both tool/resource unreachable-transition call-order tests to consume these shared constants via the existing unreachable-transition call-order helper.
  - preserved helper invocation semantics, diagnostics filter assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated primary diagnostics helper wiring across unreachable-transition and retry-window gating tests:
  - consolidated `_assert_primary_unreachable_transition_diagnostics` and `_assert_primary_retry_window_gating_diagnostics` into one shared helper for request-id scoped primary invocation/connection filter assertions.
  - migrated all four tool/resource unreachable-transition + retry-window gating call sites to the shared helper while keeping explicit expected phase/status vectors unchanged.
  - preserved existing call-order literal assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window gating call-order expectation vectors with shared constants:
  - extracted shared module-level constants for method-specific retry-window gating call-order expectations (`expected_third_slice` and full `expected_observed_call_order` tuples).
  - migrated both tool/resource retry-window gating call-order tests to consume these shared constants via the shared call-order helper.
  - preserved helper invocation semantics, diagnostics filter assertions, and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window gating call-order literal assertions with shared helper wiring:
  - added a shared integration helper that asserts retry-window gating backup-only skip slice, primary re-entry `third_slice` literals, and full `observed_call_order` literals per method.
  - migrated both tool/resource retry-window gating call-order tests to helper-driven literal assertions while keeping explicit expected tuple literals at each test call site.
  - preserved existing diagnostics filter assertions and phase-start/transport subsequence checks unchanged.
- Reduced duplicated retry-window gating expectation vectors with shared constants/helper wiring:
  - extracted shared module-level constants for primary retry-window gating expected phase/status vectors.
  - added a shared integration helper that asserts per-request primary invocation/connection diagnostics for retry-window gating sequences using explicit method + request-id order.
  - migrated both tool/resource retry-window gating call-order tests to consume the shared constants/helper while preserving explicit per-method transport call-order literals and phase-start/transport subsequence parity checks.
- Reduced duplicated unreachable-transition expectation vectors with shared constants:
  - extracted shared module-level constants for primary unreachable-transition expected phases and expected status transitions.
  - migrated tool/resource unreachable-transition diagnostics helper calls to these shared constants, removing repeated tuple literals while keeping expectations explicit and local in the integration test module.
  - preserved existing diagnostics helper invocation semantics, call-order literal assertions, and subsequence parity assertions unchanged.
- Reduced duplicated unreachable-transition call-order literal assertions with shared helper wiring:
  - added shared integration helper that asserts unreachable-transition `fifth_slice` and full `observed_call_order` literal expectations per method using explicit expected tuples supplied by each test.
  - migrated both tool and resource unreachable-transition parity tests to helper-driven call-order literal assertions while keeping explicit expected tuple lists visible at each call site.
  - preserved existing diagnostics assertions and phase-start/transport subsequence parity checks unchanged.
- Reduced duplicated unreachable-transition primary diagnostics assertions with shared helper wiring:
  - added shared integration helper to assert per-request primary invocation/connection diagnostics for unreachable-transition sequences based on explicit request-id order, method, expected phases, and expected status transitions.
  - migrated both tool and resource unreachable-transition parity tests to this shared helper while keeping explicit expected phase/status vectors at each call site.
  - preserved explicit per-test transport call-order literals (`fifth_slice`, `observed_call_order`) and existing subsequence parity assertions unchanged.
- Reduced duplicated retry-window API scenario scaffolding across gating/unreachable/simultaneous flows:
  - added shared retry-window test harness setup helper for cluster manager/clock/factory/client creation + server registration.
  - added shared invoke-construction helper and shared progression helpers for retry-window gating and simultaneous unreachable-reopen paths.
  - migrated tool/resource retry-window gating tests, tool/resource unreachable-transition tests, and simultaneous unreachable-reopen tests to use shared helpers while preserving explicit per-request diagnostics assertions and explicit transport call-order literals in each test.
- Added API-level simultaneous `UNREACHABLE` retry-window reopen parity coverage across tool/resource invoke paths:
  - added a parametrized integration regression covering both `/api/v1/mcp/invoke/tool` and `/api/v1/mcp/invoke/resource` under both preferred-order permutations.
  - assertions verify closed-window no-candidate behavior (503 + no invocation events + no transport calls), then deterministic preferred-order `initialize_start` attempt sequencing after simultaneous retry-window reopen.
  - assertions preserve helper-aligned transport semantics by checking only successful transport call literals and validating phase-start/transport subsequence parity plus deterministic diagnostics filters (`server`, `method`, `request_id`, `correlation_id`, `limit`).
- Completed call-order helper migration for remaining integration parity scenarios and added simultaneous unreachable reopen ordering matrix:
  - migrated remaining call-order parity integrations (`scripted call-order`, `repeated same-server initialize-cache`, and `force-reinitialize trigger`) to shared helpers: `collect_invocation_events_for_requests`, `expected_call_order_from_phase_starts`, and `assert_call_order_subsequence`.
  - removed repeated per-test request-id event aggregation and cursor-subsequence loops while keeping explicit observed transport-call literals unchanged.
  - added helper-level matrix coverage where both servers become `UNREACHABLE` with closed retry windows, then reopen simultaneously; assertions verify preferred-order candidate attempts via invocation `initialize_start` phase sequence and verify transport-call ordering semantics for successful initialize/invoke progression.
- Consolidated retry-window call-order subsequence helper usage and expanded non-retryable backup matrix coverage:
  - added shared convergence helpers to collect invocation events by request id, derive phase-start call-order tuples, and assert observed transport-call subsequence parity.
  - migrated retry-window gating and unreachable-transition API call-order assertions for both `tools/call` and `resources/read` to the shared subsequence helpers, removing repeated test-local cursor-loop scaffolding.
  - added helper-level unit matrix coverage for primary unreachable + backup degraded/unreachable retry-window-closed combinations, asserting deterministic no-candidate failure and deterministic backup re-entry ordering (`initialize` before invoke) after retry-window reopen.
- Reduced unreachable-transition sequence duplication and expanded backup reinitialize parity:
  - extracted shared integration helper scaffolding for unreachable-transition request progression so `tools/call` and `resources/read` API regressions reuse the same first-failover/closed-window/forced-unreachable/skip/re-entry flow while keeping per-request diagnostics-filter assertions explicit.
  - added helper-level unit coverage asserting degraded backup reinitialize call-order parity (`initialize` before invoke) when primary is forced unreachable, with paired checks for both `tools/call` and `resources/read`.
  - retained clock-driven progression and transport-order centric assertions with no direct retry-window state mutation.
- Added unreachable-transition retry-window parity for `tools/call` with shared failed-request request-id recovery:
  - added API-level `/api/v1/mcp/invoke/tool` unreachable-transition regression that mirrors healthy-first ordering constraints (primary initialize timeout -> backup serve -> forced second primary initialize timeout -> unreachable skip -> primary re-entry).
  - assertions preserve deterministic diagnostics filter behavior (`server`, `method`, `request_id`, `correlation_id`, `limit`) and transport/invocation call-order subsequence parity across the full request sequence.
  - extracted shared invocation-event delta helper for failed-request request-id recovery and applied it to both `tools/call` and `resources/read` unreachable-transition regressions.
- Added unreachable-transition retry-window parity coverage for `resources/read` under healthy-first candidate ordering:
  - helper-level matrix now drives deterministic primary `initialize` timeout transitions from degraded -> unreachable across both invoke methods while preserving backup skip/re-entry ordering.
  - API-level `/api/v1/mcp/invoke/resource` regression now forces a second primary initialize timeout via controlled backup retry-window state, verifies closed-window skip while backup serves requests, and asserts deterministic primary re-entry call order (`initialize` then `resources/read`).
  - diagnostics assertions now include deterministic failed-request request-id recovery from invocation-event delta slicing so invocation/connection filter checks remain request-correlated even for expected 503 transitions.
- Added lightweight manager clock seam for deterministic retry/backoff/freshness behavior in tests:
  - `MCPClientManager` now accepts optional `now_provider` and uses it for retry-window checks, initialization freshness gating, invocation event timestamps, and adapter freshness classification.
  - default behavior remains unchanged (`datetime.now(UTC)` when `now_provider` is not supplied).
  - added unit coverage confirming `should_retry()` consumes injected clock when `now` is omitted.
- Migrated retry-window convergence coverage to clock-driven progression:
  - removed direct `next_retry_at` mutation in the convergence integration scenario; progression now uses `clock.advance(...)` + manager APIs (`record_check_result`).
  - retained deterministic failover/recovery assertions across timeout, retry-window skip, unreachable transition, and recovery initialize.
  - preserved correlation/event determinism checks and freshness assertions after recovery.
- Expanded clock-seam adoption in remaining mixed-state tests:
  - unit and integration mixed-state recovery/fallback tests now use injected test clocks for retry-window progression instead of direct retry-window state mutation.
  - retained existing preferred-order fallback and status-transition assertions while reducing coupling to server internals.
- Extended convergence matrix with clock-driven capability snapshot timing assertions:
  - convergence scenario now explicitly verifies server-local `capability_snapshot.captured_at` retention on failure paths and replacement on recovery initialize.
  - assertions remain request-correlated and deterministic under controlled clock progression.
- Consolidated duplicated MCP test clock helpers into shared support:
  - added shared helper module `tests/support/mcp_helpers.py` and converted unit/integration MCP tests to consume `MCPTestClock`.
  - added package markers (`tests/__init__.py`, `tests/support/__init__.py`) so shared test support imports resolve consistently.
- Expanded stage-specific timeout convergence matrix with explicit paired scenarios:
  - replaced single mixed-stage convergence path with paired `initialize` vs `invoke` timeout scenarios under the same clock progression and preferred order.
  - assertions now explicitly capture stage-specific retry/backoff/status deltas and capability snapshot timing behavior (retention vs replacement) while preserving deterministic correlation/event checks.
- Reduced duplicated MCP integration transport scaffolding beyond clocks:
  - extracted reusable fake NAT transport/session helpers into `tests/support/mcp_nat_helpers.py` (`APIFakeNatSessionFactory`, `ClusterNatSessionFactory`, and session/model helpers).
  - migrated `tests/integration/test_api_mcp.py` to import shared helpers and removed duplicated test-local session factory/session model classes.
- Extended stage-paired convergence diagnostics filtering coverage:
  - for each timeout stage, added explicit deterministic assertions for `/api/v1/mcp/invocation-events` filtering by `server` + `request_id` + `limit`.
  - for each timeout stage, added explicit deterministic assertions for `/api/v1/mcp/events` filtering by `server` + `correlation_id` + `limit`.
  - kept server-local capability snapshot timing assertions and preferred-order failover/recovery determinism intact.
- Reduced remaining duplicated NAT unit transport scaffolding:
  - added shared `FakeNatSession` and `FakeNatSessionFactory` to `tests/support/mcp_nat_helpers.py`.
  - migrated `tests/unit/test_mcp_client.py` NAT adapter/session-control coverage to shared helpers and removed duplicated test-local helper classes.
- Extended diagnostics filter parity to `resources/read` failover/recovery:
  - added integration coverage asserting `/api/v1/mcp/invocation-events` filters (`server`, `method`, `request_id`, `limit`) for correlated `resources/read` failover and recovery requests.
  - added matching `/api/v1/mcp/events` filter assertions (`server`, `correlation_id`, `limit`) for the same request-correlation flows.
- Expanded shared NAT cluster helper controls for resource-read invoke failures:
  - `ClusterNatSessionFactory` now supports `fail_on_resource_reads` and `fail_on_timeout_resource_reads`.
  - `ClusterNatSession.read_resource()` now honors these controls to simulate deterministic invoke-stage resource failures/timeouts.
- Added stage-paired `resources/read` retry-window convergence coverage:
  - added paired `initialize`-timeout vs `invoke`-timeout convergence scenarios for `/api/v1/mcp/invoke/resource` under controlled clock progression.
  - assertions preserve stage-specific retry/unreachable behavior, server-local capability snapshot timing (retention vs replacement), and deterministic correlated diagnostics-filter semantics.
- Reduced stage-matrix assertion duplication:
  - extracted shared convergence helpers into `tests/support/mcp_convergence_helpers.py`.
  - migrated stage-paired `tools/call`/`resources/read` convergence tests to shared phase/filter assertion helpers.
- Added scripted mixed-method flapping controls and coverage:
  - `ClusterNatSessionFactory` now supports ordered per-server/per-method scripted actions (`ok`/`timeout`/`error`) via `set_failure_script(...)`.
  - added integration coverage that validates deterministic fallback order and correlation streams across scripted `tools/call` and `resources/read` flapping without manual failure-set toggling between calls.
- Extended scripted-failure realism to initialize stage:
  - `ClusterNatSession.initialize()` now consumes scripted actions for method `initialize` before set-based timeout toggles.
  - integration coverage validates script-precedence semantics (`initialize: ok` overrides set timeout) and scripted initialize-timeout failover behavior.
- Expanded convergence-helper adoption in diagnostics tests:
  - migrated remaining diagnostics-filter assertions in `tests/integration/test_api_mcp.py` to `tests/support/mcp_convergence_helpers.py`.
  - preserved existing filter semantics (`server`, `method`, `request_id`, `correlation_id`, `limit`) while reducing repeated test-local assertion boilerplate.
- Added focused unit coverage for scripted helper semantics:
  - added unit tests for `ClusterNatSessionFactory.set_failure_script/consume_failure_action` covering ordering, unsupported actions, script exhaustion, and fallback to set-based toggles.
  - explicit method-key checks cover `initialize`, `tools/call`, and `resources/read`.
- Added scripted `error` action convergence coverage:
  - integration coverage now exercises scripted `error` at initialize-stage and invoke-stage paths, asserting stable `transport_error` classification and deterministic failover/correlation behavior.
- Extended scripted `error` convergence parity to `resources/read`:
  - added paired initialize/invoke scripted-error scenarios for `/api/v1/mcp/invoke/resource`, asserting deterministic failover order, stable `transport_error` classification, and correlated request behavior.
  - added deterministic invocation/connection filter assertions for correlated `resources/read` requests (`server`, `method`, `request_id`, `correlation_id`, `limit`).
- Added helper-level scripted-failure isolation coverage:
  - added unit assertions that per-server/per-method scripts remain isolated under shared `ClusterNatSessionFactory` state.
  - added mixed-script regression checks across `primary` and `backup` so consuming one key does not mutate unrelated script queues.
- Extended scripted initialize precedence parity to `resources/read`:
  - added integration coverage proving scripted `initialize: ok` for `resources/read` overrides set-based initialize timeout toggles and keeps the correlated request free of degraded transitions.
  - retained deterministic diagnostics-filter coverage (`server`, `method`, `request_id`, `correlation_id`, `limit`) and added fallback verification after adapter invalidation when set-based timeout toggles reapply.
- Added API-level mixed-script isolation regression:
  - added integration sequencing across `tools/call` and `resources/read` with mixed scripts on `primary` and `backup`.
  - assertions now verify only targeted server/method script queues are consumed per request while unrelated queues remain intact until exercised.
- Added API-level mixed initialize+invoke script isolation coverage:
  - added integration coverage that combines per-server `initialize` scripts with `tools/call` and `resources/read` scripts in one deterministic scenario across `primary` and `backup`.
  - assertions verify initialize-script queue consumption is isolated from invoke-script queues while preserving deterministic failover order and correlated diagnostics filters.
- Added initialize-script exhaustion regression at API level:
  - added integration coverage proving scripted initialize override depletion falls back to set-based initialize timeout toggles after adapter invalidation.
  - assertions verify fallback degradation/correlation behavior and confirm unrelated invoke method script queues remain untouched until explicitly invoked.
- Added helper/API call-order parity coverage for mixed scripted failover:
  - added unit coverage asserting deterministic `ClusterNatSessionFactory.calls` ordering across mixed `initialize` + `tools/call` + `resources/read` scripted actions for paired `primary`/`backup` failover.
  - added API integration coverage that cross-checks `factory.calls` against invocation-event `initialize_start`/`invoke_start` ordering for one mixed scripted `tools/call` + `resources/read` sequence.
  - call-order comparison now intentionally uses subsequence semantics so event streams that include stage markers without matching transport calls remain deterministic and non-flaky.
- Added initialize-cache call-order parity coverage for repeated requests:
  - added unit coverage proving repeated same-server invokes skip extra transport `initialize` calls until explicit adapter invalidation, with paired checks for both `tools/call` and `resources/read`.
  - unit assertions now also verify invalidation forces exactly one subsequent transport `initialize` and rotates to a new adapter session id.
  - added API coverage for repeated same-server `tools/call` + `resources/read` requests without invalidation, asserting call-order remains one `initialize` followed by invoke methods while invocation-phase start streams remain aligned via subsequence parity.
  - retained deterministic diagnostics-filter checks (`server`, `method`, `request_id`, `correlation_id`, `limit`) per request in the new API scenario.
- Added force-reinitialize trigger call-order parity coverage:
  - added helper-level unit coverage asserting stale-expiry and non-healthy-status trigger paths each force transport `initialize` before the next invoke.
  - unit coverage includes paired `tools/call` and `resources/read` assertions so trigger parity remains method-consistent.
  - added API-level repeated-request regression that injects stale-expiry and degraded-status transitions between calls and verifies transport call-order contains the expected additional `initialize` calls.
  - retained deterministic diagnostics-filter assertions per request and preserved invocation-phase to transport-call subsequence parity checks in the new API scenario.
- Added retry-window gating call-order parity coverage:
  - added helper-level unit coverage asserting degraded and unreachable retry-window-closed servers are skipped without primary transport calls and re-enter deterministically once retry windows reopen.
  - unit assertions include paired `tools/call` and `resources/read` checks and explicit re-entry call-order expectations (`initialize` before invoke).
  - added API-level regression covering timeout -> closed retry window skip -> retry-window reopen while backup serves requests.
  - API assertions now cross-check transport call order against invocation-event `initialize_start`/`invoke_start` phase streams via subsequence parity and keep deterministic diagnostics-filter checks (`server`, `method`, `request_id`, `correlation_id`, `limit`) per request.
- Extended retry-window parity coverage for `resources/read` and backup-state matrix behavior:
  - added helper-level `resources/read` matrix coverage distinguishing backup non-retryable degraded vs unreachable states under mixed preferred ordering before primary re-entry.
  - added API-level `/api/v1/mcp/invoke/resource` retry-window call-order regression mirroring timeout -> closed retry-window skip -> retry-window reopen while backup serves requests.
  - preserved deterministic diagnostics-filter checks and invocation-phase/transport-call subsequence parity assertions per request.

## Active Next Slice (Recommended)
Continue `P12/P13` test-structure hardening by extending stable assertion-vector constant reuse for repeated server-name list expectations in unit MCP client coverage:
1. Reuse shared unit-test constants for repeated assertion-side server-name list vectors in `tests/unit/test_mcp_client.py`:
   - target repeated list expectations such as `[UNIT_TEST_SERVER_A, UNIT_TEST_SERVER_B]` and repeated single-item vectors `[UNIT_TEST_SERVER_C]` where reuse is meaningful.
   - keep registration/setup literals, preferred-order inputs, transport payload literals, and method-branch conditionals explicit and unchanged.
2. Preserve regression and semantics:
   - keep focused timeout-category constant regression coverage explicit and unchanged.
   - preserve invocation-event/connection-event filters and call-order/subsequence behavior unchanged.
3. Keep scope and workflow tight:
   - scope edits to `tests/unit/test_mcp_client.py` only (no product code changes).
   - run full validation and update both plan docs after completion.

## Resume Checklist
1. Sync and verify environment:
   - `git pull`
   - `./.venv313/bin/python --version`
2. Read context docs:
   - `todo/master_plan.md`
   - `todo/plans/mcp_server.md`
   - `todo/plans/mcp_client.md`
3. Implement one slice end-to-end (code + tests + plan updates).
4. Run validation:
   - `./.venv313/bin/ruff format .`
   - `./.venv313/bin/ruff check .`
   - `PYTHONPATH=src ./.venv313/bin/mypy`
   - `PYTHONPATH=src ./.venv313/bin/pytest`
5. Record new state back into this file and `todo/master_plan.md`.

## Key Files for Next Slice
- `src/att/mcp/client.py`
- `src/att/api/routes/mcp.py`
- `src/att/api/schemas/mcp.py`
- `tests/unit/test_mcp_client.py`
- `tests/integration/test_api_mcp.py`
- `tests/support/mcp_convergence_helpers.py`
- `tests/support/mcp_nat_helpers.py`
- `src/att/api/deps.py`

## Remaining Program-Level Milestones
From `todo/master_plan.md`:
- `P12/P13` still in progress for full NAT `nat.mcp` transport integration and live external server wiring.
- `P16` still in progress (release-source adapter chain + failure-class/deployment-context rollback policy matrix delivered; remaining work is deeper production rollout hardening).
- `P15` and `P17-P25` not started.

## Working Agreement
- Keep edits small, test-backed, and incremental.
- Update plan files as work progresses, not only at the end.
- If blocked, record blocker + attempted approach in this file before stopping.
